<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Compare — Go Go Ratings</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
  <style>
    /* Page-specific bits kept minimal to fit your existing CSS */
    .controls{display:flex;flex-direction:column;gap:10px;padding:14px 18px;border-bottom:1px solid var(--border, #444)}
    .row{display:flex;gap:8px;align-items:center;width:100%}
    .row input[type="text"]{flex:1;min-width:220px;padding:10px;border-radius:8px;border:1px solid var(--border, #444);background:transparent;color:inherit}
    .btn{background:transparent;border:1px solid var(--border, #444);color:inherit;padding:8px 12px;border-radius:6px;cursor:pointer}
    .btn:hover{background:rgba(255,255,255,0.05)}
    .muted-note{opacity:.8;font-size:.9rem}
    .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    /* Autocomplete */
    .suggest{position:relative;flex:1}
    .suggest-list{
      position:absolute;left:0;right:0;top:100%;
      max-height:220px;overflow:auto;margin-top:4px;
      border:1px solid var(--border, #444);background:inherit;border-radius:6px;
      display:none;z-index:20
    }
    .suggest-item{padding:8px 10px;cursor:pointer}
    .suggest-item:hover{background:rgba(255,255,255,.05)}
    #chart{height:520px}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <h1 class="site-title"><a href="index.html">Go Go Ratings</a></h1>
  </div>
</header>

<main class="wrap">
  <section class="panel">
    <h2 style="margin:0;padding:16px 18px;border-bottom:1px solid var(--border, #444)">Compare</h2>

    <div class="controls">
      <div class="toolbar">
        <div id="rows" style="flex:1"></div>
        <div style="display:flex;gap:8px;align-items:center">
          <label for="agg">View:</label>
          <select id="agg">
            <option value="daily">Daily</option>
            <option value="monthly" selected>Monthly</option>
            <option value="yearly">Yearly</option>
          </select>
        </div>
      </div>

      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button id="add" class="btn" type="button">Add player</button>
        <button id="create" class="btn" type="button">Create</button>
        <button id="clear" class="btn" type="button">Clear</button>
      </div>
      <div class="muted-note">Up to 6 players. Start typing a name, pick a suggestion, then Create.</div>
    </div>

    <div style="padding:16px">
      <div id="chart">Loading…</div>
    </div>
  </section>
</main>

<script>
  // --- config ---------------------------------------------------------------
  const PLAYERS_URL = 'data/players.json';
  const HIST_URL    = id => `data/history/${encodeURIComponent(id)}.json`;
  const MAX_PLAYERS = 6;
  const IS_TOUCH    = window.matchMedia('(pointer: coarse)').matches;

  // --- state ----------------------------------------------------------------
  const state = {
    players: [],     // [{id, name, ...}] from players.json
    inputs: [],      // [{ el, input }]
    loaded: []       // [{ name, daily: [{x,y}] }]
  };

  // --- utils: normalise & aggregate (mirrors player page) -------------------
  function normalise(series, dedupeByDay = false){
    const s = series
      .filter(p => p && p.x && Number.isFinite(p.y))
      .map(p => ({ x: p.x, y: +p.y }))
      .sort((a,b) => new Date(a.x) - new Date(b.x));

    if (!dedupeByDay) return s;

    const out = [];
    let lastKey = null;
    for (const p of s) {
      const d = new Date(p.x);
      const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
      if (key !== lastKey) out.push(p);
      else out[out.length-1] = p; // keep last point that day
      lastKey = key;
    }
    return out;
  }

  function aggregate(series, mode){
    if (mode === 'daily') return normalise(series, true);

    const buckets = Object.create(null);
    for (const p of series) {
      const d = new Date(p.x);
      const key = (mode === 'monthly')
        ? `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`
        : `${d.getFullYear()}`;
      (buckets[key] ||= []).push(p.y);
    }
    const out = Object.keys(buckets).sort().map(k => {
      const ys = buckets[k].filter(Number.isFinite);
      const avg = ys.reduce((a,b)=>a+b,0) / ys.length;
      const x = (k.length === 7) ? `${k}-01` : `${k}-01-01`;
      return { x, y: avg };
    });
    return normalise(out, false);
  }

  // --- autocomplete ---------------------------------------------------------
  function attachAutocomplete(input){
    const wrap = document.createElement('div');
    wrap.className = 'suggest';
    input.parentNode.insertBefore(wrap, input);
    wrap.appendChild(input);

    const list = document.createElement('div');
    list.className = 'suggest-list';
    wrap.appendChild(list);

    function render(items){
      if (!items.length){ list.style.display='none'; list.innerHTML=''; return; }
      list.innerHTML = items.map(n => `<div class="suggest-item" data-name="${n}">${n}</div>`).join('');
      list.style.display = 'block';
    }

    input.addEventListener('input', () => {
      const q = input.value.trim().toLowerCase();
      if (!q){ render([]); return; }
      const names = state.players.map(p => p.name);
      const starts = names.filter(n => n.toLowerCase().startsWith(q));
      const contains = names.filter(n => !n.toLowerCase().startsWith(q) && n.toLowerCase().includes(q));
      render(starts.concat(contains).slice(0, 12));
    });

    list.addEventListener('mousedown', e => {
      const item = e.target.closest('.suggest-item');
      if (!item) return;
      input.value = item.dataset.name;
      list.style.display='none';
    });

    input.addEventListener('keydown', e => {
      if (e.key === 'Enter'){
        const first = list.querySelector('.suggest-item');
        if (first){ input.value = first.dataset.name; list.style.display='none'; }
      }
      if (e.key === 'Escape') list.style.display='none';
    });

    input.addEventListener('blur', () => setTimeout(() => { list.style.display='none'; }, 120));
  }

  // --- rows -----------------------------------------------------------------
  function makeRow(){
    if (state.inputs.length >= MAX_PLAYERS) return;
    const rows = document.getElementById('rows');

    const wrap = document.createElement('div');
    wrap.className = 'row';

    const input = document.createElement('input');
    input.type = 'text';
    input.placeholder = 'Search player…';
    wrap.appendChild(input);
    attachAutocomplete(input);

    const remove = document.createElement('button');
    remove.className = 'btn';
    remove.type = 'button';
    remove.textContent = 'Remove';
    remove.addEventListener('click', () => {
      rows.removeChild(wrap);
      state.inputs = state.inputs.filter(r => r.el !== wrap);
      document.getElementById('add').disabled = state.inputs.length >= MAX_PLAYERS;
    });

    wrap.appendChild(remove);
    rows.appendChild(wrap);

    state.inputs.push({ el: wrap, input });
    document.getElementById('add').disabled = state.inputs.length >= MAX_PLAYERS;
  }

  function clearAll(){
    document.getElementById('rows').innerHTML = '';
    state.inputs = [];
    state.loaded = [];
    document.getElementById('add').disabled = false;
    document.getElementById('chart').textContent = 'Cleared.';
  }

  // --- data load ------------------------------------------------------------
  async function loadPlayers(){
    const res = await fetch(PLAYERS_URL, { cache: 'no-cache' });
    if (!res.ok) throw new Error('players.json not found');
    state.players = await res.json();
  }

  // --- grid helpers ---------------------------------------------------------
  function majorGridShapes(ymin, ymax){
    const shapes = [];
    for (let v = ymin; v <= ymax; v += 100){
      shapes.push({
        type: 'line',
        xref: 'paper', x0: 0, x1: 1,
        y0: v, y1: v,
        line: { width: 1, color: 'rgba(128,128,128,0.35)' },
        layer: 'below'
      });
    }
    return shapes;
  }

  // --- chart ----------------------------------------------------------------
  function drawChart(){
    const el = document.getElementById('chart');
    if (el.textContent && el.textContent.includes('Loading')) el.textContent = '';

    if (!state.loaded.length){
      el.textContent = 'No players selected.';
      return;
    }

    const mode = document.getElementById('agg').value;

    // Aggregate each series per current mode
    const traces = state.loaded.map(s => {
      const data = aggregate(s.daily, mode);
      const xs = data.map(p => p.x);
      const ys = data.map(p => p.y);
      return {
        type: 'scatter',
        name: s.name,
        x: xs,
        y: ys,
        mode: (mode === 'daily') ? 'lines' : 'lines+markers',
        line: { width: 2, shape: 'linear' },
        marker: (mode === 'daily') ? { size: 0 } : { size: 4 },
        hovertemplate: '%{x}<br>%{y:.0f}<extra></extra>',
        connectgaps: true
      };
    });

    const allY = traces.flatMap(t => t.y).filter(Number.isFinite);
    if (!allY.length){
      el.textContent = 'No games';
      return;
    }
    const ymin = Math.floor(Math.min(...allY) / 100) * 100;
    const ymax = Math.ceil(Math.max(...allY) / 100) * 100;

    const bg = getComputedStyle(document.body).backgroundColor;
    Plotly.newPlot('chart', traces, {
      margin: { l:50, r:20, t:10, b:40 },
      xaxis: { type:'date' },
      yaxis: { title:'Rating' },
      paper_bgcolor: bg,
      plot_bgcolor: bg,
      font: { color: getComputedStyle(document.body).color },
      shapes: majorGridShapes(ymin, ymax),
      legend: { x:1, y:0, bgcolor:'rgba(0,0,0,0)' }
    }, {
      staticPlot: IS_TOUCH,
      displayModeBar: false,
      responsive: true
    });
  }

  async function createChart(){
    const names = state.inputs
      .map(r => r.input.value.trim())
      .filter(Boolean);

    // de-dupe by exact name
    const uniq = [...new Set(names)];
    if (!uniq.length) { alert('Please add at least one player'); return; }

    const lookups = uniq.map(name => {
      const player = state.players.find(p => p.name === name);
      if (!player) return null;
      return { name, id: player.id };
    }).filter(Boolean);

    if (!lookups.length){
      document.getElementById('chart').textContent = 'No valid players.';
      return;
    }

    // fetch all histories
    const results = await Promise.all(lookups.map(async ({name, id}) => {
      const res = await fetch(HIST_URL(id), { cache: 'no-cache' });
      if (!res.ok) return null;
      const hist = await res.json();
      const daily = normalise(hist.map(d => ({ x: d.date, y: Number(d.rating) })), true);
      if (!daily.length) return null;
      return { name, daily };
    }));

    state.loaded = results.filter(Boolean);
    drawChart();
  }

  // --- boot -----------------------------------------------------------------
  window.addEventListener('DOMContentLoaded', () => {
    document.getElementById('add').addEventListener('click', makeRow);
    document.getElementById('clear').addEventListener('click', clearAll);
    document.getElementById('create').addEventListener('click', createChart);
    document.getElementById('agg').addEventListener('change', drawChart);

    loadPlayers()
      .then(() => { makeRow(); })
      .catch(e => {
        console.error(e);
        document.querySelector('.muted-note').textContent =
          'Could not load player list. Check data path or run via a local server.';
        makeRow();
      });
  });
</script>
</body>
</html>
