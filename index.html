<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Go Go Ratings</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
  <style>
    #compare-chart { height: 800px; }
    .toolbar { margin-bottom: 10px; }
    /* Modal */
    #compare-modal {
      display:none;
      position:fixed;
      top:0; left:0;
      width:100%; height:100%;
      background:rgba(0,0,0,0.6);
      justify-content:center;
      align-items:center;
      z-index:9999;
    }
    #compare-modal > div {
      background:#1a1a1a;
      padding:20px;
      border-radius:8px;
      max-width:500px;
      width:90%;
      max-height:80%;
      overflow:auto;
      color:#fff;
    }
    .compare-controls {
      margin: 10px 0;
    }
    .compare-controls button {
      margin-right:10px;
    }
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <h1 class="site-title"><a href="index.html">Go Go Ratings</a></h1>
    <nav class="topnav" aria-label="Main">
      <a href="index.html" class="active-tab">Home</a>
      <a href="compare.html">Compare</a>
      <a href="peak.html">Peak</a>
    </nav>
  </div>
</header>

<main class="wrap">
  <section class="panel" id="players-panel">
    <h2>All players</h2>
    <div class="toolbar">
      <input id="q" type="search" placeholder="Filter by name…">
      <span id="count" class="muted"></span>
      <button id="compare-btn" class="club-btn" type="button" style="margin-left:auto">Compare</button>
    </div>
    <div id="compare-wrap" style="display:none; padding:16px">
      <div id="compare-chart"></div>
    </div>
    <div class="table-wrap">
      <table id="players">
        <thead>
          <tr>
            <th style="min-width:60px">Rank</th>
            <th style="min-width:240px">Player</th>
            <th class="right" style="min-width:120px">Rating</th>
          </tr>
        </thead>
        <tbody><!-- filled by JS --></tbody>
      </table>
    </div>
  </section>

  <!-- Compare Selection Modal -->
  <div id="compare-modal">
    <div>
      <h3>Select players to view:</h3>
      <div class="compare-controls">
        <button id="compare-show-top">Show Selected</button>
        <button id="compare-cancel-top">Cancel</button>
      </div>
      <div id="compare-list" style="margin:10px 0 20px 0;"></div>
      <div class="compare-controls">
        <button id="compare-show-bottom">Show Selected</button>
        <button id="compare-cancel-bottom">Cancel</button>
      </div>
    </div>
  </div>
</main>

<script>
  const DATA_URL = 'data/players.json';
  const state = { rows: [], filtered: [] };
  const histCache = new Map();
  const IS_TOUCH = window.matchMedia('(pointer: coarse)').matches;

  function render() {
    const tbody = document.querySelector('#players tbody');
    tbody.innerHTML = '';
    state.filtered.forEach((r, i) => {
      const tr = document.createElement('tr');
      const tdRank = document.createElement('td');
      tdRank.textContent = i + 1;
      tr.appendChild(tdRank);

      const tdName = document.createElement('td');
      const a = document.createElement('a');
      a.href = `player.html?id=${encodeURIComponent(r.id)}`;
      a.textContent = r.name;
      tdName.appendChild(a);
      tr.appendChild(tdName);

      const tdRt = document.createElement('td');
      tdRt.className = 'right';
      tdRt.textContent = r.rating;
      tr.appendChild(tdRt);

      tbody.appendChild(tr);
    });
    document.getElementById('count').textContent =
      `${state.filtered.length.toLocaleString()} players`;
  }

  function applyFilter() {
    const q = document.getElementById('q').value.trim().toLowerCase();
    state.filtered = !q
      ? state.rows.slice()
      : state.rows.filter(r => r.name.toLowerCase().includes(q));
    render();
    hideCompare();
  }

  async function fetchHistoryFor(id) {
    if (histCache.has(id)) return histCache.get(id);
    try {
      const res = await fetch(`data/history/${encodeURIComponent(id)}.json`, { cache: 'no-cache' });
      if (!res.ok) return null;
      const rows = await res.json();
      histCache.set(id, rows);
      return rows;
    } catch { return null; }
  }

  function hideCompare() {
    document.getElementById('compare-wrap').style.display = 'none';
    document.getElementById('compare-chart').innerHTML = '';
  }

  async function buildComparison(players) {
    const wrap = document.getElementById('compare-wrap');
    const chart = document.getElementById('compare-chart');
    wrap.style.display = 'block';
    chart.innerHTML = 'Loading…';

    const traces = [];
    let ymin = Infinity, ymax = -Infinity;

    for (const p of players) {
      const hist = await fetchHistoryFor(p.id);
      if (!hist || !hist.length) continue;

      const xs = hist.map(d => d.date);
      const ys = hist.map(d => Number(d.rating));
      ymin = Math.min(ymin, ...ys);
      ymax = Math.max(ymax, ...ys);

      traces.push({
        type: 'scatter',
        name: p.name,
        x: xs,
        y: ys,
        mode: 'lines',
        line: { width: 2, shape: 'linear' },
        hovertemplate: '%{x}<br>%{y:.0f}<extra>' + p.name + '</extra>',
        connectgaps: true
      });
    }

    if (!traces.length) {
      chart.innerHTML = 'No history found.';
      return;
    }

    ymin = Math.floor(ymin / 100) * 100;
    ymax = Math.ceil(ymax / 100) * 100;
    const shapes = [];
    for (let v = ymin; v <= ymax; v += 100) {
      shapes.push({
        type: 'line', xref: 'paper', x0: 0, x1: 1,
        y0: v, y1: v,
        line: { width: 1, color: 'rgba(128,128,128,0.35)' },
        layer: 'below'
      });
    }

    const cs = getComputedStyle(document.body);
    const layout = {
      margin: { l: 50, r: 20, t: 10, b: 40 },
      xaxis: { type: 'date' },
      yaxis: { title: 'Rating' },
      legend: { orientation: 'h' },
      paper_bgcolor: cs.backgroundColor,
      plot_bgcolor: cs.backgroundColor,
      font: { color: cs.color },
      shapes
    };

    Plotly.newPlot(chart, traces, layout, {
      staticPlot: IS_TOUCH,
      displayModeBar: false,
      responsive: true
    });
  }

  function setupCompareButton() {
    const modal = document.getElementById('compare-modal');
    const listDiv = document.getElementById('compare-list');

    function openModal() {
      listDiv.innerHTML = '';
      state.filtered.forEach(p => {
        const id = `chk-${p.id}`;
        const wrapper = document.createElement('div');
        wrapper.innerHTML = `
          <label>
            <input type="checkbox" id="${id}" value="${p.id}" style="margin-right:6px">
            ${p.name} (${p.rating})
          </label>
        `;
        listDiv.appendChild(wrapper);
      });
      modal.style.display = 'flex';
    }

    function closeModal() {
      modal.style.display = 'none';
    }

    function showSelected() {
      const selectedIds = Array.from(listDiv.querySelectorAll('input:checked')).map(cb => cb.value);
      if (!selectedIds.length) {
        alert('Please select at least one player.');
        return;
      }
      closeModal();
      const chosen = state.filtered.filter(p => selectedIds.includes(p.id));
      buildComparison(chosen);
    }

    document.getElementById('compare-btn').addEventListener('click', openModal);

    document.getElementById('compare-show-top').addEventListener('click', showSelected);
    document.getElementById('compare-show-bottom').addEventListener('click', showSelected);

    document.getElementById('compare-cancel-top').addEventListener('click', closeModal);
    document.getElementById('compare-cancel-bottom').addEventListener('click', closeModal);
  }

  async function load() {
    try {
      const res = await fetch(DATA_URL, { cache: 'no-cache' });
      if (!res.ok) throw new Error('Failed to load players.json');
      const data = await res.json();
      state.rows = data
        .filter(d => d && d.name && Number.isFinite(+d.rating))
        .map(d => ({ id: d.id, name: d.name, rating: +d.rating }))
        .sort((a, b) => b.rating - a.rating);
      state.filtered = state.rows.slice();
      render();
    } catch (err) {
      document.querySelector('#players tbody').innerHTML =
        `<tr><td colspan="3">Error loading data: ${err.message}</td></tr>`;
    }
  }

  document.getElementById('q').addEventListener('input', applyFilter);
  setupCompareButton();
  load();
</script>
</body>
</html>
